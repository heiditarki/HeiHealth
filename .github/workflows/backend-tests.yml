name: Backend Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx

      - name: Start backend server
        run: |
          python run.py &
          sleep 5
        env:
          PYTHONUNBUFFERED: 1

      - name: Test API endpoints
        run: |
          # Test health endpoint
          curl -f http://127.0.0.1:8000/health || exit 1
          
          # Test SMART launch
          curl -f "http://127.0.0.1:8000/smart/launch?patient=eps-001&org=OYS" || exit 1
          curl -f "http://127.0.0.1:8000/smart/launch?patient=eps-005&org=TAYS" || exit 1
          
          # Test patients list endpoint
          curl -f http://127.0.0.1:8000/patients || exit 1
          
          # Test FHIR endpoints for eps-001
          curl -f http://127.0.0.1:8000/fhir/Patient/eps-001 || exit 1
          curl -f "http://127.0.0.1:8000/fhir/Condition?patient=eps-001" || exit 1
          curl -f "http://127.0.0.1:8000/fhir/Observation?patient=eps-001" || exit 1
          
          # Test FHIR endpoints for eps-005 (with UUID patient ID)
          curl -f http://127.0.0.1:8000/fhir/Patient/eps-005 || exit 1
          curl -f "http://127.0.0.1:8000/fhir/Condition?patient=eps-005" || exit 1
          curl -f "http://127.0.0.1:8000/fhir/Observation?patient=eps-005" || exit 1
          
          echo "All API endpoints are working!"

      - name: Test invalid requests
        run: |
          # Test 404 for invalid patient
          response=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8000/fhir/Patient/invalid)
          if [ "$response" != "404" ]; then
            echo "Expected 404, got $response"
            exit 1
          fi
          
          # Test 400 for missing patient parameter
          response=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8000/fhir/Condition)
          if [ "$response" != "400" ]; then
            echo "Expected 400, got $response"
            exit 1
          fi
          
          echo "Error handling tests passed!"
